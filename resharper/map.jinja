# -*- coding: utf-8 -*-
# vim: ft=jinja

# Start with defaults from defs.yaml 
{% import_yaml 'resharper/defaults.yaml' as defs %}

{% set ide = salt['pillar.get']( 'resharper', default=defs.resharper, merge=True) %}

# Set Jetbrains IDE latest release details
{% if grains.os == 'Windows' or ide.jetbrains.edition in ('None', '',) %}
   {%- set pcode = ide.jetbrains.product %}
{%- set jdata = salt['cmd.run']('curl {0} {1}{2}'.format(ide.dl.opts, ide.jetbrains.uri, pcode))|load_yaml %}

{% if ide.jetbrains.edition %} 
  {% set _home = '{0}\\resharper-{1}-{2}'.format( ide.prefix, ide.jetbrains.edition, jdata[ pcode ][0]['version']) %}
{% else %}
  {% set _home = '{0}\\resharper-{1}'.format( ide.prefix, jdata[ pcode ][0]['version']) %}
{% endif %}

{% do ide.jetbrains.update({ 'realhome': _home, 'realcmd': _home ~ ide.command },) %}

# Set Jetbrains IDE download details
{%- set src_hashurl = jdata[ pcode ][0]['downloads'][ ide.osflavour ]['checksumLink'] %}
{%- set src_hashsum  = salt['cmd.run']('curl -s {0}'.format( src_hashurl )).split(' ')[0] %}
{% do ide.dl.update({
       'source_url'  : jdata[ pcode ][0]['downloads'][ ide.osflavour ]['link'],
       'archive_name': jdata[ pcode ][0]['downloads'][ ide.osflavour ]['link'].split('/') | last ,
       'src_hashurl' : src_hashurl,
       'src_hashsum' : src_hashsum,
    )
%}
{% set resharper = ide %}

